
// This file is part of Man, a robotic perception, locomotion, and
// team strategy application created by the Northern Bites RoboCup
// team of Bowdoin College in Brunswick, Maine, for the Aldebaran
// Nao robot.
//
// Man is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Man is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Lesser Public License for more details.
//
// You should have received a copy of the GNU General Public License
// and the GNU Lesser Public License along with Man.  If not, see
// <http://www.gnu.org/licenses/>.

#include "PreviewController.h"
using std::list;

#include "motionconfig.h"

#ifdef DEBUG_MOTION
#  define DEBUG_CONTROLLER_GAINS
#endif

using namespace NBMath;

// generated by scilab.
const float PreviewController::weights[NUM_PREVIEW_FRAMES] =
{39.929727f, -8.999180f, -8.042051f, -7.186710f, -6.422341f, -5.739270f, -5.128849f, -4.583352f, -4.095873f, -3.660242f, -3.270944f, -2.923051f, -2.612159f, -2.334333f, -2.086057f, -1.864187f, -1.665915f, -1.488730f, -1.330391f, -1.188892f, -1.062444f, -0.949444f, -0.848462f, -0.758221f, -0.677577f, -0.605511f, -0.541110f, -0.483558f, -0.432128f, -0.386167f, -0.345095f, -0.308391f, -0.275591f, -0.246280f, -0.220086f, -0.196678f, -0.175759f, -0.157066f, -0.140360f, -0.125432f, -0.112091f, -0.100169f, -0.089515f, -0.079995f, -0.071487f, -0.063883f, -0.057089f, -0.051017f, -0.045591f, -0.040742f, -0.036409f, -0.032536f, -0.029076f, -0.025983f, -0.023220f, -0.020750f, -0.018543f, -0.016571f, -0.014808f, -0.013233f};

const float PreviewController::A_c_values[9] =
{ 1.0021071f,   0.0192912f,  -0.0039916f,
  0.0000001f,   0.8936414f,  -0.2828039f,
  2.0021066f,   0.3560861f,  -0.1084655f };

const float PreviewController::b_values[3] =
{ - 0.0000422f,
  - 0.0063292f,
    0.02f };

const float PreviewController::c_values[3] =
{ 0.0f, 0.0f, 1.0f };

PreviewController::PreviewController()
    : WalkController(), stateVector(ufvector3(3)),
      A_c(ufmatrix3(3,3)), b(ufvector3(3)), c(ufrowVector3(1,3)) {
    // instantiate the ublas matrices with their respective values
    // TODO: there might be a better way to do this.
    for (int i=0; i < 3; i++)
        stateVector(i) = 0.0f;

    for (int i=0; i < 3; i++)
        A_c(0, i) = A_c_values[i];
    for (int i=0; i < 3; i++)
        A_c(1, i) = A_c_values[3+i];
    for (int i=0; i < 3; i++)
        A_c(2, i) = A_c_values[6+i];

    for (int i=0; i < 3; i++)
        b(i) = b_values[i];

    for (int i=0; i < 3; i++)
        c(0,i) = c_values[i];

#ifdef DEBUG_CONTROLLER_GAINS
    FILE * gains_log;
    gains_log = fopen("/tmp/gains_log.xls","w");
    int j = 0;
    fprintf(gains_log,"time\tgain\n");
    //write the controller gains
    for(unsigned int i  = 0; i < NUM_PREVIEW_FRAMES; i++){
        fprintf(gains_log,"%d\t%f\n",j,weights[j]);
        j++;
    }
    fclose(gains_log);
#endif

}

/**
 * Tick calculates the next state vector for the robot, given the zmp_ref
 *
 */
const float PreviewController::tick(const list<float> *zmp_ref,
                                    const float cur_zmp_ref,
                                    const float sensor_zmp) {
    float control = 0.0f; // This is 'u' in mathematical notation
    unsigned int counter = 0;
    for (list<float>::const_iterator i = zmp_ref->begin();
         counter < NUM_PREVIEW_FRAMES; counter++, i++) {
        control += weights[counter]* (*i);
    }
    stateVector.assign(prod(A_c, stateVector) + b*control);
    return getPosition();
}

/**
 * Initialize the position of the robot (vel and accel assumed to be 0)
 */
void PreviewController::initState(float x, float v, float p){
    stateVector(0) = x;
    stateVector(1) = v;
    stateVector(2) = p;

}
